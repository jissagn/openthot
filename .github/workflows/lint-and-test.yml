name: Lint and test
on:
  push:
    branches:
      - "**"
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  black:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Set up Python 3.11
        uses: actions/setup-python@v3
        with:
          python-version: "3.11"
      - name: Install Black
        run: pip install black
      - name: Run black formatter Check
        run: black --check .

  flake8:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Set up Python 3.11
        uses: actions/setup-python@v3
        with:
          python-version: "3.11"
      - name: Install flake8
        run: pip install flake8
      - name: Run flake8
        uses: julianwachholz/flake8-action@v2.0.2
        with:
          checkName: "flake8"

  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Set up Python 3.11
        uses: actions/setup-python@v3
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry install
      - name: Test with pytest
        run: |
          poetry run pytest
        env:
          ASR_ENGINE: whisperx
          CELERY_BROKER_URL: sqla:///./data/celery_broker.sqlite
          CELERY_RESULT_BACKEND: sqla:///./data/celery_backend.sqlite
          DATABASE_URL: sqlite+aiosqlite:///./data/sql_app.db
          OBJECT_STORAGE_PATH: ./data/object_storage
          WHISPER_MODEL_SIZE: tiny
          WHISPERX_COMPUTE_TYPE: int8
          HF_TOKEN: hf_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
          USERS_TOKEN_ROOT_SECRET: secret
